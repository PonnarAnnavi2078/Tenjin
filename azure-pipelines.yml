trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'
    
variables:
  IPADDR: 'https://192.168.17.29'
  INSID: 'tenjinonlineregression'
  APITOKEN: 'bUi7RW26YQtbbk+M91Qs4y0URTBDPTtxji8mNKDrX7OGf4FAHAV8v5uCCU8+zkCcqqCqeji1o5duY+/j3LdQxQugNP0WWJ2ORRZ9qEY9wYcHtCU+yAvTL1aaAjuSEIBjEPs0EpMuxU9uX5c+dBYHMzBzv71QA0X+7f1RAPVq/vM5Y90u940CTCur47Kt+Ay5cUdEjKgwJyIF1xJNtL3xuCtHi0O01Nv9Ljji6uzaOCelYFF/XmVebA0fhcFAh50OALeVq/ISgMLHfffRP9uMxD3i0ttSQztZmTM4drjOFRDk0baCL3e1T5YQI5CdTu7b+vfk1CGXDGb4UYCnkv3zKQ=='
  AGENTNAME: 'Arpita_TOT'
  INCLUDECLOUDDEVICE: 'FALSE'
  INCLUDECLOUDBROWSER: 'FALSE'
  DEVICENAME: ''
  PROJECTKEY: 'AIA'
  BROWSER: 'chrome'
  REGION: 'UTC+05:30'
  TESTRUNID: 'Test-Run-13056691'
  ISCLOUDAGENT: 'FALSE'
  BROWSERVERSION: ''
  OS: 'Windows 8.1'
  RUNONLYFAILED: 'FALSE'

steps:
  - script: |
      echo "Installing dependencies..."
      sudo apt-get update -y
      command -v curl >/dev/null 2>&1 || sudo apt-get install -y curl
      command -v jq >/dev/null 2>&1 || sudo apt-get install -y jq
    displayName: 'Install dependencies'

  - script: |
      echo "Starting Execute Test Run..."
      EXECUTE=$(curl -s -k -X POST "$IPADDR/api/rest/1/execute/testrun" \
        -H "Content-Type: application/json" \
        -H "X-INS-ID: $INSID" \
        -H "X-API-TOKEN: $APITOKEN" \
        -d '{
          "agentName": "'"$AGENTNAME"'",
          "includeCloudDevice": "'"$INCLUDECLOUDDEVICE"'",
          "includeCloudBrowser": "'"$INCLUDECLOUDBROWSER"'",
          "device": "'"$DEVICENAME"'",
          "projectKey": "'"$PROJECTKEY"'",
          "browser": "'"$BROWSER"'",
          "region": "'"$REGION"'",
          "testRunId": "'"$TESTRUNID"'",
          "cloudAgent": "'"$ISCLOUDAGENT"'",
          "browserVersion": "'"$BROWSERVERSION"'",
          "os": "'"$OS"'",
          "reRunFailedCases": "'"$RUNONLYFAILED"'"
        }')
      echo "EXECUTE response: $EXECUTE"

      TEST_RUN_ID=$(echo $EXECUTE | jq -r '.testRunId')
      echo "Test Run ID: $TEST_RUN_ID"

      if [ -z "$TEST_RUN_ID" ] || [ "$TEST_RUN_ID" == "null" ]; then
        echo "Failed to retrieve test run ID"
        exit 1
      fi

      # Only monitor if cloud agent is TRUE
      if [ "$ISCLOUDAGENT" == "TRUE" ]; then
        echo "Cloud agent detected. Monitoring test run..."
        status=''
        agentstatus=''
        result=''
        end_time=$(($(date +%s) + 3600)) # 1 hour timeout
        count=0

        while [[ $status != 'COMPLETED' && $agentstatus != 'TERMINATED' && $agentstatus != 'ERROR' && $(date +%s) -lt $end_time ]]; do
          echo "Loop count: $count"
          response=$(curl -s -k "$IPADDR/api/rest/1/testruns/$TEST_RUN_ID/runstatus" \
            -H "Content-Type: application/json" \
            -H "X-INS-ID: $INSID" \
            -H "X-API-TOKEN: $APITOKEN")
          echo "API response: $response"

          status=$(echo $response | jq -r '.status')
          result=$(echo $response | jq -r '.result')
          agentstatus=$(echo $response | jq -r '.cloudAgentStatus')

          echo "Parsed status: $status"
          echo "Parsed result: $result"
          echo "Parsed agent status: $agentstatus"

          if [[ $result == 'FAIL' || $status == 'null' ]]; then
            echo "Test run failed or invalid."
            exit 1
          fi

          sleep 20
          count=$((count+1))
        done
      else
        echo "Default/local agent. Skipping monitor step."
      fi
    displayName: 'Execute and Monitor Test Run'
